<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - equirectangular video panorama</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background-color: #000000;
            margin: 0px;
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 0px;
            width: 100%;
            color: #ffffff;
            padding: 5px;
            font-family: Monospace;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
        }

        a {
            color: #ffffff;
        }
    </style>
</head>
<body>
<!--
https://threejs.org/examples/textures/pano.webm
https://threejs.org/build/three.min.js
-->
<video id="video" style="display:none" autoplay playsinline></video>

<script type="text/javascript" src="https://threejs.org/build/three.min.js"></script>
<script type="x-shader/x-fragment" id="webcam">

    uniform vec3      iResolution;           // viewport resolution (in pixels)
    uniform float     iTime;                 // shader playback time (in seconds)
    uniform float     iTimeDelta;            // render time (in seconds)
    uniform int       iFrame;                // shader playback frame
    uniform sampler2D camera;                 // input channel
    uniform float     iSampleRate;           // sound sample rate (i.e., 44100)


    void mainImage( out vec4 fragColor, in vec2 fragCoord ) {


        vec2 source_uv = fragCoord.xy / iResolution.xy;
        vec2 distortion_center = vec2(0.5,0.5);

        float distortion_x,distortion_y,rr,r2,theta;

        float distortion_k1 = -1.1 ,distortion_k2 = 1.2;
        vec2 dest_uv;


        rr = sqrt((source_uv.x - distortion_center.x)*(source_uv.x - distortion_center.x) + (source_uv.y - distortion_center.y)*(source_uv.y - distortion_center.y));
        r2 = rr * (1.0 + distortion_k1*(rr*rr) + distortion_k2*(rr*rr*rr*rr));
        theta = atan(source_uv.x - distortion_center.x, source_uv.y - distortion_center.y);
        distortion_x = sin(theta) * r2 * 0.8;//1.0 is  scale factor
        distortion_y = cos(theta) * r2 * 1.0;//1.0 is  scale factor
        dest_uv.x = distortion_x + 0.5;
        dest_uv.y = distortion_y + 0.5;

        fragColor = vec4( texture( camera, dest_uv).r, texture( camera,dest_uv).g,texture( camera,dest_uv).b, 1. );

    }

</script>
<script type="module">

    import * as THREE from './three.js-master/build/three.module.js'

    let camera, scene, renderer, video;

    init();
    animate();

    function init() {

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 5;

        scene = new THREE.Scene();

        video = document.getElementById('video');

        const texture = new THREE.VideoTexture(video);

        const geometry = new THREE.PlaneBufferGeometry(16, 9);
        geometry.scale(0.5, 0.5, 0.5);
        const material = new THREE.MeshBasicMaterial({map: texture});

        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.set(0, 0,0);
        mesh.lookAt(camera.position);
        scene.add(mesh);


        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);


        window.addEventListener('resize', onWindowResize, false);

        //

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {

            const constraints = {video: {width: 1280, height: 720, facingMode: 'user'}};

            navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                // apply the stream to the video element used in the texture
                video.srcObject = stream;
                video.play();
            }).catch(function (error) {

                console.error('Unable to access the camera/webcam.', error);

            });
        } else {

            console.error('MediaDevices interface not available.');
        }
    }
    function cameraShader(){


        const material = new THREE.ShaderMaterial()
    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);

    }


</script>
</body>
</html>